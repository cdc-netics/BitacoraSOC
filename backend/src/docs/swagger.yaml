openapi: 3.0.0
info:
  title: Bitácora SOC API
  description: API completa para el sistema de Bitácora SOC con gestión de entradas, checklist de turno, usuarios y reportes
  version: 1.0.0
  contact:
    name: Bitácora SOC Team

servers:
  - url: http://192.168.100.50:3000/api
    description: Servidor de desarrollo (IP)
  - url: http://localhost:3000/api
    description: Servidor local

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  
  schemas:
    User:
      type: object
      properties:
        _id:
          type: string
        username:
          type: string
        email:
          type: string
        fullName:
          type: string
        role:
          type: string
          enum: [admin, user, guest]
        isActive:
          type: boolean
        theme:
          type: string
          enum: [light, dark, sepia, pastel]
        guestExpiresAt:
          type: string
          format: date-time
        createdAt:
          type: string
          format: date-time
    
    Entry:
      type: object
      properties:
        _id:
          type: string
        content:
          type: string
        entryType:
          type: string
          enum: [operativa, incidente]
        entryDate:
          type: string
          format: date
        entryTime:
          type: string
          pattern: '^([01]\d|2[0-3]):([0-5]\d)$'
        tags:
          type: array
          items:
            type: string
        createdBy:
          type: string
        createdByUsername:
          type: string
        isGuestEntry:
          type: boolean
        createdAt:
          type: string
          format: date-time
    
    ShiftCheck:
      type: object
      properties:
        _id:
          type: string
        userId:
          type: string
        username:
          type: string
        type:
          type: string
          enum: [inicio, cierre]
        checkDate:
          type: string
          format: date-time
        services:
          type: array
          items:
            type: object
            properties:
              serviceId:
                type: string
              serviceTitle:
                type: string
              status:
                type: string
                enum: [verde, rojo]
              observation:
                type: string
        hasRedServices:
          type: boolean
        createdAt:
          type: string
          format: date-time
    
    Error:
      type: object
      properties:
        message:
          type: string
        errors:
          type: array
          items:
            type: object

paths:
  /auth/login:
    post:
      tags:
        - Autenticación
      summary: Iniciar sesión
      description: Autentica un usuario y devuelve un token JWT. Reemplace CHANGE_ME por credenciales reales (ver .env).
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - username
                - password
              properties:
                username:
                  type: string
                  example: admin
                password:
                  type: string
                  example: CHANGE_ME
      responses:
        '200':
          description: Login exitoso
          content:
            application/json:
              schema:
                type: object
                properties:
                  token:
                    type: string
                  user:
                    $ref: '#/components/schemas/User'
        '401':
          description: Credenciales inválidas
  
  /users:
    get:
      tags:
        - Usuarios
      summary: Listar usuarios
      description: Obtiene la lista de todos los usuarios (solo admin)
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Lista de usuarios
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/User'
    
    post:
      tags:
        - Usuarios
      summary: Crear usuario
      description: Crea un nuevo usuario (solo admin)
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - username
                - email
                - password
                - fullName
                - role
              properties:
                username:
                  type: string
                  example: jperez
                email:
                  type: string
                  example: jperez@example.com
                password:
                  type: string
                  example: password123
                fullName:
                  type: string
                  example: Juan Pérez
                role:
                  type: string
                  enum: [admin, user, guest]
                  example: user
      responses:
        '201':
          description: Usuario creado
        '400':
          description: Error de validación
  
  /users/me:
    get:
      tags:
        - Usuarios
      summary: Obtener perfil
      description: Obtiene el perfil del usuario autenticado
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Perfil del usuario
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
    
    put:
      tags:
        - Usuarios
      summary: Actualizar perfil
      description: Actualiza el perfil del usuario autenticado
      security:
        - bearerAuth: []
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                email:
                  type: string
                fullName:
                  type: string
                theme:
                  type: string
                  enum: [light, dark, sepia, pastel]
                currentPassword:
                  type: string
                newPassword:
                  type: string
      responses:
        '200':
          description: Perfil actualizado
  
  /entries:
    get:
      tags:
        - Entradas
      summary: Listar entradas
      description: Obtiene entradas con filtros y paginación
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: page
          schema:
            type: integer
            default: 1
        - in: query
          name: limit
          schema:
            type: integer
            default: 20
        - in: query
          name: search
          schema:
            type: string
          description: Búsqueda de texto completo
        - in: query
          name: tags
          schema:
            type: string
          description: Tags separados por comas
          example: trellix,hunting
        - in: query
          name: entryType
          schema:
            type: string
            enum: [operativa, incidente]
        - in: query
          name: startDate
          schema:
            type: string
            format: date
        - in: query
          name: endDate
          schema:
            type: string
            format: date
        - in: query
          name: userId
          schema:
            type: string
      responses:
        '200':
          description: Lista de entradas
          content:
            application/json:
              schema:
                type: object
                properties:
                  entries:
                    type: array
                    items:
                      $ref: '#/components/schemas/Entry'
                  pagination:
                    type: object
                    properties:
                      total:
                        type: integer
                      page:
                        type: integer
                      limit:
                        type: integer
                      totalPages:
                        type: integer
    
    post:
      tags:
        - Entradas
      summary: Crear entrada
      description: Crea una nueva entrada en la bitácora
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - content
                - entryType
                - entryDate
                - entryTime
              properties:
                content:
                  type: string
                  example: Revisión de alertas en #Trellix. Todo operativo. #hunting
                entryType:
                  type: string
                  enum: [operativa, incidente]
                  example: operativa
                entryDate:
                  type: string
                  format: date
                  example: "2025-12-17"
                entryTime:
                  type: string
                  example: "14:30"
      responses:
        '201':
          description: Entrada creada
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  entry:
                    $ref: '#/components/schemas/Entry'
  
  /entries/tags/suggest:
    get:
      tags:
        - Entradas
      summary: Autocompletar tags
      description: Sugiere tags basados en el texto ingresado
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: q
          required: true
          schema:
            type: string
          example: tre
      responses:
        '200':
          description: Lista de sugerencias
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    tag:
                      type: string
                    count:
                      type: integer
  
  /checklist/services:
    get:
      tags:
        - Checklist
      summary: Obtener servicios activos
      description: Lista los servicios activos del catálogo
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Lista de servicios
    
    post:
      tags:
        - Checklist
      summary: Crear servicio
      description: Crea un nuevo servicio en el catálogo (solo admin)
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - title
              properties:
                title:
                  type: string
                  example: QRadar
                order:
                  type: integer
                  example: 1
      responses:
        '201':
          description: Servicio creado
  
  /checklist/check:
    post:
      tags:
        - Checklist
      summary: Registrar checklist de turno
      description: |
        Registra un checklist de inicio o cierre de turno
        
        **Reglas:**
        - No se permiten dos acciones iguales consecutivas
        - Debe respetar el cooldown configurable (default 240 minutos)
        - Todos los servicios en rojo DEBEN tener observación
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - type
                - services
              properties:
                type:
                  type: string
                  enum: [inicio, cierre]
                  example: inicio
                services:
                  type: array
                  items:
                    type: object
                    required:
                      - serviceId
                      - serviceTitle
                      - status
                    properties:
                      serviceId:
                        type: string
                      serviceTitle:
                        type: string
                      status:
                        type: string
                        enum: [verde, rojo]
                      observation:
                        type: string
                        maxLength: 1000
            example:
              type: inicio
              services:
                - serviceId: "675e1234567890abcdef1234"
                  serviceTitle: QRadar
                  status: verde
                  observation: ""
                - serviceId: "675e1234567890abcdef1235"
                  serviceTitle: Zabbix
                  status: rojo
                  observation: "Alerta de CPU en servidor prod-01"
      responses:
        '201':
          description: Checklist registrado
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  check:
                    $ref: '#/components/schemas/ShiftCheck'
        '400':
          description: Error de validación o reglas de negocio
  
  /checklist/check/last:
    get:
      tags:
        - Checklist
      summary: Último check del usuario
      description: Obtiene el último checklist registrado por el usuario
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Último check
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ShiftCheck'
  
  /notes/admin:
    get:
      tags:
        - Notas
      summary: Obtener nota del administrador
      description: Obtiene la nota global del administrador (visible para todos)
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Nota del administrador
    
    put:
      tags:
        - Notas
      summary: Actualizar nota del administrador
      description: Actualiza la nota global (solo admin)
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                content:
                  type: string
      responses:
        '200':
          description: Nota actualizada
  
  /notes/personal:
    get:
      tags:
        - Notas
      summary: Obtener nota personal
      description: Obtiene la nota personal del usuario (privada)
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Nota personal
    
    put:
      tags:
        - Notas
      summary: Actualizar nota personal
      description: Actualiza la nota personal del usuario
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                content:
                  type: string
      responses:
        '200':
          description: Nota actualizada
  
  /smtp:
    get:
      tags:
        - SMTP
      summary: Obtener configuración SMTP
      description: Obtiene la configuración del servidor de correo (solo admin)
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Configuración SMTP
    
    post:
      tags:
        - SMTP
      summary: Configurar SMTP
      description: Crea o actualiza la configuración SMTP (solo admin)
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - provider
                - username
                - password
                - host
                - port
                - useTLS
                - senderName
                - senderEmail
                - recipients
                - sendOnlyIfRed
              properties:
                provider:
                  type: string
                  enum: [office365, aws-ses, elastic-email, google-mail, google-workspace, mailgun, custom]
                username:
                  type: string
                password:
                  type: string
                host:
                  type: string
                port:
                  type: integer
                useTLS:
                  type: boolean
                senderName:
                  type: string
                senderEmail:
                  type: string
                recipients:
                  type: array
                  items:
                    type: string
                sendOnlyIfRed:
                  type: boolean
      responses:
        '200':
          description: Configuración guardada
  
  /smtp/test:
    post:
      tags:
        - SMTP
      summary: Probar configuración SMTP
      description: Envía un correo de prueba (solo admin)
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Correo enviado exitosamente
        '500':
          description: Error al enviar correo
  
  /reports/overview:
    get:
      tags:
        - Reportes
      summary: Vista general de KPIs
      description: Obtiene estadísticas generales del sistema (solo admin)
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: days
          schema:
            type: integer
            default: 30
      responses:
        '200':
          description: KPIs del sistema
          content:
            application/json:
              schema:
                type: object
                properties:
                  period:
                    type: string
                  entriesByType:
                    type: object
                  incidentsByUser:
                    type: array
                  topTags:
                    type: array
                  redsByService:
                    type: array
                  entriesTrend:
                    type: array
                  totalUsers:
                    type: integer
                  totalChecks:
                    type: integer
  
  /reports/export-entries:
    get:
      tags:
        - Reportes
      summary: Exportar entradas a CSV
      description: Exporta entradas filtradas a formato CSV (solo admin)
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: startDate
          schema:
            type: string
            format: date
        - in: query
          name: endDate
          schema:
            type: string
            format: date
      responses:
        '200':
          description: Archivo CSV
          content:
            text/csv:
              schema:
                type: string
  
  /config:
    get:
      tags:
        - Configuración
      summary: Obtener configuración
      description: Obtiene la configuración global de la aplicación
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Configuración actual
    
    put:
      tags:
        - Configuración
      summary: Actualizar configuración
      description: Actualiza la configuración global (solo admin)
      security:
        - bearerAuth: []
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                guestModeEnabled:
                  type: boolean
                guestMaxDurationDays:
                  type: integer
                  minimum: 1
                  maximum: 30
                shiftCheckCooldownHours:
                  type: integer
                  minimum: 1
                  maximum: 1440
                logoUrl:
                  type: string
      responses:
        '200':
          description: Configuración actualizada
  
  /backup/mongo:
    get:
      tags:
        - Backup
      summary: Crear backup de MongoDB
      description: Crea un backup completo de la base de datos (solo admin)
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Backup creado
  
  /backup/list:
    get:
      tags:
        - Backup
      summary: Listar backups
      description: Lista todos los backups disponibles (solo admin)
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Lista de backups
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    name:
                      type: string
                    path:
                      type: string
                    created:
                      type: string
                      format: date-time
                    size:
                      type: integer
