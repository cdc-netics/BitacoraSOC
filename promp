Perfecto. **Aqu√≠ tienes el PROMPT FINAL, limpio, completo y coherente**, integrando **todo lo hablado**, sin contradicciones y listo para pegar **tal cual** en Copilot / ChatGPT / repo / issue de desarrollo.

No te agrego nada extra, solo lo que definiste y lo que es t√©cnicamente correcto para un SOC.

---

# PROMPT FINAL ‚Äî Bit√°cora SOC

**Angular (frontend) + Express (backend) + MongoDB**
*(sin Docker, ejecuci√≥n por IP, enfoque desktop)*

Act√∫a como **desarrollador senior full-stack**. Construye una aplicaci√≥n web tipo **Bit√°cora SOC** para analistas, con gesti√≥n de entradas, clasificaci√≥n de incidentes, checklist de turno configurable, notas, temas, reportes y notificaciones por correo.
Entrega **c√≥digo funcional**, estructura de proyecto, modelos, endpoints, frontend completo y **documentaci√≥n total de la API**.

---

## 0) Restricciones obligatorias

* **NO usar Docker**
* Proyecto separado en:

  * `frontend/` ‚Üí Angular
  * `backend/` ‚Üí Express
* Backend **Express** (no NestJS).
* Responsive **prioridad desktop**.
* UI con **Angular Material** + animaciones a discreci√≥n (anime.js permitido).
* Timezone oficial: **America/Santiago (Chile)**.
* **Debe correr por IP, no localhost**:

  * Backend escuchando en `0.0.0.0`
  * Angular con `ng serve --host 0.0.0.0`
  * CORS configurado por IP
  * `API_BASE_URL` configurable en Angular
* Documentaci√≥n **completa** de la API:

  * Swagger / OpenAPI
  * README con ejemplos curl y reglas de negocio

---

## 1) Roles y autenticaci√≥n

Roles:

* `admin`
* `user`
* `guest`

### 1.1 Usuarios

* **NO existe registro p√∫blico**
* **Solo el admin crea usuarios** desde ‚ÄúAdmin usuarios‚Äù
* Autenticaci√≥n JWT (access token; refresh opcional)

### 1.2 Modo invitado (guest)

* Configurable **solo por admin**:

  * Switch: ‚ÄúHabilitar modo invitado‚Äù
  * Duraci√≥n m√°xima: **2 d√≠as**
* Guest expira autom√°ticamente (token inv√°lido / sesi√≥n cerrada)
* Guest puede:

  * Escribir entradas
  * Ver ‚Äúüåç Ver todas‚Äù
* Guest NO puede:

  * Admin
  * Configuraciones
  * Reportes
* Las entradas guest deben quedar marcadas como tal

---

## 2) Men√∫ lateral (exacto)

### Admin

1. Escribir
2. Mis entradas
3. üåç Ver todas
4. üë§ Mi Perfil
5. Admin usuarios
6. Tags
7. Reportes
8. Logo
9. Backup
10. Salir

### Usuario com√∫n

1. Escribir
2. üåç Ver todas
3. üë§ Mi Perfil
4. Salir

> El usuario com√∫n **NO** tiene ‚ÄúMis entradas‚Äù.

---

## 3) Pantalla principal: **Escribir (Nueva entrada)** ‚≠ê

Esta vista es **siempre visible** y es la **principal del sistema**.

UI (como la imagen):

* T√≠tulo: **Nueva entrada**
* Campos superiores:

  * Fecha (date picker, precargada con fecha Chile)
  * Hora (time picker, precargada con hora Chile)
* √Årea de texto grande:

  * Placeholder:
    `Escribe aqu√≠. Usa # para tags (ej: #Trellix #hunting)`
* Bot√≥n: **Subir**
* La entrada **NO depende** del checklist de turno

### 3.1 Clasificaci√≥n de la entrada (OBLIGATORIA)

Al costado del caj√≥n de texto debe existir un selector visible:

* (‚óè) **Entrada operativa** *(default)*
* ( ) **Incidente**

Reglas:

* Toda entrada **debe** tener tipo
* Solo una opci√≥n activa
* Visible siempre

Backend:

```js
entryType: 'operativa' | 'incidente'
```

---

## 4) Entradas (modelo y l√≥gica)

Entidad: `Entry`

Campos m√≠nimos:

* content
* entryType (`operativa` | `incidente`)
* entryDate
* entryTime
* tags (array lowercase)
* createdBy (user / guest)
* createdAt

Funcionalidad:

* Hashtags autom√°ticos (`#tag`)
* Autocomplete de tags (`GET /tags/suggest`)
* ‚Äúüåç Ver todas‚Äù con:

  * paginaci√≥n server-side
  * filtros por texto, tags, fechas, tipo
* Autosave en edici√≥n (debounce + dirty-check)

√çndices:

* text index en `content`
* index en `tags`
* index en `entryType`
* index en `createdAt`

---

## 5) Notas Duales (sidebar derecho fijo)

Siempre visibles.

### 5.1 Notas del Administrador

* Globales
* Admin escribe
* Todos ven
* Autosave

### 5.2 Notas Personales

* Privadas por usuario
* Autosave

---

## 6) Sistema de Temas

* Light / Dark / Sepia / Pastel
* CSS variables
* Persistencia en localStorage (+ opcional perfil)

---

## 7) Checklist de Turno (Acorde√≥n bajo el men√∫) ‚≠ê

Acorde√≥n colapsable **independiente de las entradas**.

### 7.1 Configuraci√≥n (solo admin)

El admin define el **cat√°logo de servicios**:

* Agregar / eliminar servicios
* Editar **t√≠tulo visible**
* Ordenar
* Activar / desactivar

Ejemplo:

```
[ ] QRadar
[ ] Zabbix
[ ] Wazuh
```

---

### 7.2 Uso por el analista

Selector:

* Inicio de turno
* Cierre de turno

Por cada servicio:

```
[ Verde / Rojo ] QRadar
[ Observaci√≥n ............ ]

[ Verde / Rojo ] Zabbix
[ Observaci√≥n ............ ]
```

Reglas:

* Todos los servicios **deben** tener estado
* Si est√° rojo:

  * Observaci√≥n **obligatoria**
  * M√°x **1000 caracteres**
* Validar frontend y backend

---

### 7.3 Regla anti-spam (NO por d√≠a)

NO existen turnos fijos.

Implementar:

* **No permitir acciones iguales consecutivas**

  * Inicio ‚Üí debe venir Cierre
  * Cierre ‚Üí debe venir Inicio
* **Cooldown en horas configurable por admin**

  * Default: 4 horas
  * Campo: `shiftCheckCooldownHours`
* Bloquear registros antes del cooldown

Auditor√≠a:

* userId
* tipo (inicio / cierre)
* timestamp Chile
* servicios + estado + observaci√≥n
* IP / userAgent (opcional)

---

### 7.4 Indicador visual del acorde√≥n (CORRECTO)

Mostrar estado del **√∫ltimo check real**, no ‚Äúhecho hoy‚Äù:

* Inicio:

  * ‚úÖ OK ‚Üí sin servicios en rojo
  * ‚õî Con problemas ‚Üí al menos un rojo
* Cierre:

  * ‚úÖ OK
  * ‚õî Con problemas
* Si no existe: ‚Äú‚Äî sin registro‚Äù

---

## 8) SMTP / Correo (UI tipo Passbolt) ‚≠ê

Pantalla **Servidor de correo electr√≥nico** como las im√°genes.

### 8.1 Configuraci√≥n SMTP

Campos:

* Proveedor:

  * Office 365
  * AWS SES
  * ElasticEmail
  * Google Mail
  * Google Workspace
  * MailGun
  * Custom
* M√©todo autenticaci√≥n:

  * Usuario / contrase√±a
* Usuario
* Contrase√±a (nunca visible)
* Configuraci√≥n avanzada:

  * Host SMTP
  * TLS (S√≠/No)
  * Puerto
  * Cliente SMTP (hostname/IP)

### 8.2 Remitente

* Nombre del remitente
* Correo del remitente

### 8.3 Destinatarios

* Lista din√°mica (N correos)
* Toggle:

  * Enviar solo si hay rojos
  * Enviar siempre

### 8.4 Funcionalidad

* Bot√≥n **Probar configuraci√≥n**
* Al registrar check:

  * Enviar correo seg√∫n reglas

Seguridad:

* Password SMTP cifrada en backend
* Nunca retornarla al frontend

---

## 9) Backup / Logo / Tags

* Logo:

  * Admin puede cambiar logo (png/svg o URL)
* Backup:

  * Export CSV
  * Backup + restore Mongo (mongodump / mongorestore)
  * Auditor√≠a
* Tags:

  * m√©tricas y normalizaci√≥n

---

## 10) Reportes

KPIs:

* Entradas operativas vs incidentes
* Incidentes por analista
* Top tags
* Checks con rojos por servicio
* Tendencias 30 d√≠as

Dashboard visual.

---

## 11) Backend Express

* JWT + RBAC
* Validaciones DTO
* CORS por IP
* Rate-limit login
* Modelos:

  * User
  * Entry
  * AdminNote
  * PersonalNote
  * ServiceCatalog
  * ShiftCheck
  * SmtpConfig
  * AppConfig

---

## 12) Frontend Angular

* Layout desktop:

  * Sidebar izquierda + acorde√≥n
  * Contenido central
  * Sidebar derecha fijo
* Angular Material + anime.js
* Autosave RxJS
* Guards por rol
* Environments con IP

---

## 13) Ejecuci√≥n por IP (OBLIGATORIO)

README con pasos exactos:

```bash
# Backend
HOST=0.0.0.0 PORT=3000 npm run dev

# Frontend
ng serve --host 0.0.0.0 --port 4200
```

Ejemplo `API_BASE_URL`:

```
http://10.0.101.150:3000/api
```

---

## Output esperado

* C√≥digo funcional completo
* Scripts npm
* `.env.example`
* Swagger + README API
* Supuestos documentados

---

### Opini√≥n directa (como pediste)

Este dise√±o **est√° correcto**, es **SOC real**, auditable, escalable y usable en turnos.
No hay nada ‚Äúsobrado‚Äù ni inventado.

Si quieres, el siguiente paso l√≥gico es:
üëâ **definir exactamente los endpoints y esquemas Mongo** y despu√©s **dibujar el layout Angular** p√≠xel a p√≠xel.
