<div class="settings-container">
  <h1>Configuracion</h1>

  <mat-card class="config-card" id="general-config">
    <mat-card-header>
      <mat-card-title>Configuración General</mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <form [formGroup]="appConfigForm" (ngSubmit)="saveAppConfig()">
        <mat-checkbox formControlName="guestEnabled" id="guest-mode">
          Habilitar modo invitado
        </mat-checkbox>

        <div class="config-row">
          <mat-checkbox formControlName="checklistAlertEnabled">
            Avisar checklist no realizado
          </mat-checkbox>

          <mat-form-field appearance="outline">
            <mat-label>Hora límite</mat-label>
            <input matInput type="time" formControlName="checklistAlertTime">
            <mat-hint>Solo admins pueden cambiar este horario</mat-hint>
          </mat-form-field>
        </div>

        <button mat-raised-button color="primary" type="submit"
                [disabled]="!appConfigForm.valid">
          Guardar
        </button>
      </form>
    </mat-card-content>
  </mat-card>

  <mat-card class="smtp-card" id="smtp-config">
    <mat-card-header>
      <mat-card-title>Configuracion SMTP</mat-card-title>
      <span class="status-chip" [ngClass]="connectionStatus">
        {{ connectionStatus === 'conectado' ? 'Conectado' : connectionStatus === 'desconectado' ? 'Desconectado' : 'Sin configurar' }}
      </span>
    </mat-card-header>
    <mat-card-content>
      <form [formGroup]="smtpForm" (ngSubmit)="saveSmtpConfig()">
        <div class="grid two-cols">
          <mat-form-field appearance="outline">
            <mat-label>Proveedor</mat-label>
            <mat-select formControlName="provider">
              <mat-option *ngFor="let p of providers" [value]="p.value">{{ p.label }}</mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Host</mat-label>
            <input matInput formControlName="host">
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Puerto</mat-label>
            <input matInput type="number" formControlName="port">
          </mat-form-field>

          <mat-checkbox formControlName="useTLS">
            Conexión segura (SSL/TLS)
          </mat-checkbox>

          <mat-form-field appearance="outline">
            <mat-label>Usuario</mat-label>
            <input matInput formControlName="username">
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Contraseña</mat-label>
            <input matInput type="password" formControlName="password">
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Nombre Remitente</mat-label>
            <input matInput formControlName="senderName">
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Email Remitente</mat-label>
            <input matInput type="email" formControlName="senderEmail">
          </mat-form-field>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Destinatarios (separados por coma) - Opcional</mat-label>
            <textarea matInput rows="2" formControlName="recipientsText" 
                      placeholder="Solo necesarios si deseas enviar emails de prueba o notificaciones"></textarea>
            <mat-hint>La conexión SMTP funciona sin destinatarios. Los emails se enviarán cuando haya incidentes críticos.</mat-hint>
          </mat-form-field>
        </div>

        <mat-checkbox formControlName="sendOnlyIfRed">
          Enviar correo solo si hay servicios en rojo (si no, envía siempre)
        </mat-checkbox>

        <div class="button-group">
          <button mat-raised-button color="accent" type="button"
                  (click)="testSmtp()" [disabled]="testing">
            <mat-spinner *ngIf="testing" diameter="18"></mat-spinner>
            <span *ngIf="!testing">Probar conexion</span>
          </button>

          <button mat-raised-button color="primary" type="submit"
                  [disabled]="!smtpTestPassed || savingSmtp">
            <mat-spinner *ngIf="savingSmtp" diameter="18"></mat-spinner>
            <span *ngIf="!savingSmtp">Guardar SMTP</span>
          </button>
        </div>
      </form>
    </mat-card-content>
  </mat-card>
</div>
