<div class="container">
  <mat-card class="page-header">
    <h1>ðŸ“ž Escalamiento y Turnos</h1>
    <p>Vista simplificada de contactos y turnos de la semana</p>
  </mat-card>

  <!-- SECCIÃ“N 1: TURNOS DE LA SEMANA (Interno) -->
  <mat-card class="section-card">
    <div class="week-header">
      <h2>ðŸ‘¥ Turnos de esta Semana</h2>
      <div class="week-navigation">
        <button mat-icon-button (click)="previousWeek()" matTooltip="Semana anterior">
          <mat-icon>chevron_left</mat-icon>
        </button>
        <span class="week-label">{{ getWeekLabel() }}</span>
        <button mat-icon-button (click)="nextWeek()" matTooltip="Semana siguiente">
          <mat-icon>chevron_right</mat-icon>
        </button>
        <button mat-raised-button color="primary" (click)="setCurrentWeek(); loadWeekShifts()" *ngIf="!isCurrentWeek()" class="btn-current">
          <mat-icon>today</mat-icon>
          Semana Actual
        </button>
      </div>
    </div>
    <p class="subtitle">Personal de turno en nuestra empresa</p>

    <div *ngIf="loadingShifts" class="loading-container">
      <mat-spinner diameter="40"></mat-spinner>
    </div>

    <div *ngIf="!loadingShifts" class="shifts-grid">
      <!-- N2 -->
      <div class="shift-card">
        <div class="shift-header n2">
          <mat-icon>engineering</mat-icon>
          <h3>N2 - Soporte TÃ©cnico</h3>
        </div>
        <div class="shift-body">
          <div class="shift-user" *ngIf="weekShifts.N2">
            <mat-icon>person</mat-icon>
            <div class="user-info">
              <strong>{{ weekShifts.N2?.currentUser?.name || 'No asignado' }}</strong>
              <small *ngIf="weekShifts.N2?.currentUser?.email">ðŸ“§ {{ weekShifts.N2.currentUser.email }}</small>
              <small *ngIf="weekShifts.N2?.currentUser?.phone">ðŸ“± {{ weekShifts.N2.currentUser.phone }}</small>
            </div>
          </div>
          <div class="shift-empty" *ngIf="!weekShifts.N2">
            <mat-icon>person_off</mat-icon>
            <span>Sin asignar</span>
          </div>
        </div>
      </div>

      <!-- TI -->
      <div class="shift-card">
        <div class="shift-header ti">
          <mat-icon>computer</mat-icon>
          <h3>TI - Infraestructura</h3>
        </div>
        <div class="shift-body">
          <div class="shift-user" *ngIf="weekShifts.TI">
            <mat-icon>person</mat-icon>
            <div class="user-info">
              <strong>{{ weekShifts.TI?.currentUser?.name || 'No asignado' }}</strong>
              <small *ngIf="weekShifts.TI?.currentUser?.email">ðŸ“§ {{ weekShifts.TI.currentUser.email }}</small>
              <small *ngIf="weekShifts.TI?.currentUser?.phone">ðŸ“± {{ weekShifts.TI.currentUser.phone }}</small>
            </div>
          </div>
          <div class="shift-empty" *ngIf="!weekShifts.TI">
            <mat-icon>person_off</mat-icon>
            <span>Sin asignar</span>
          </div>
        </div>
      </div>

      <!-- N1 NO HÃBIL -->
      <div class="shift-card">
        <div class="shift-header n1">
          <mat-icon>schedule</mat-icon>
          <h3>N1 - No HÃ¡bil</h3>
        </div>
        <div class="shift-body">
          <div class="shift-user" *ngIf="weekShifts.N1_NO_HABIL">
            <mat-icon>person</mat-icon>
            <div class="user-info">
              <strong>{{ weekShifts.N1_NO_HABIL?.currentUser?.name || 'No asignado' }}</strong>
              <small *ngIf="weekShifts.N1_NO_HABIL?.currentUser?.email">ðŸ“§ {{ weekShifts.N1_NO_HABIL.currentUser.email }}</small>
              <small *ngIf="weekShifts.N1_NO_HABIL?.currentUser?.phone">ðŸ“± {{ weekShifts.N1_NO_HABIL.currentUser.phone }}</small>
            </div>
          </div>
          <div class="shift-empty" *ngIf="!weekShifts.N1_NO_HABIL">
            <mat-icon>person_off</mat-icon>
            <span>Sin asignar</span>
          </div>
        </div>
      </div>
    </div>
  </mat-card>

  <!-- SECCIÃ“N 2: TABLA DE ESCALAMIENTO -->
  <mat-card class="section-card">
    <h2>ðŸ“‹ Contactos de Escalamiento</h2>
    <p class="subtitle">Lista de contactos por servicio</p>

    <!-- Selector de Cliente -->
    <div class="client-selector" *ngIf="allClients.length > 0">
      <mat-form-field appearance="outline" class="client-field">
        <mat-label>Seleccionar Cliente</mat-label>
        <mat-select [(ngModel)]="selectedClient">
          <mat-option *ngFor="let client of allClients" [value]="client">
            {{ client.name }}
          </mat-option>
        </mat-select>
      </mat-form-field>
    </div>

    <div *ngIf="loading" class="loading-container">
      <mat-spinner diameter="40"></mat-spinner>
    </div>

    <div *ngIf="!loading && selectedClient && selectedClientData" class="excel-table-container">
      <h3 class="client-title">{{ selectedClient.name }}</h3>
      
      <div *ngFor="let service of selectedClientData.services" class="service-section">
        <div class="service-header-row">
          <h4>{{ selectedClient?.name }} â€” {{ service.name }}</h4>
          <span *ngIf="service.emergencyPhone" class="emergency-badge">TelÃ©fono emergencia: {{ service.emergencyPhone }}</span>
        </div>

        <table class="excel-table simple-table">
          <thead>
            <tr>
              <th>Nombre</th>
              <th>Para</th>
              <th>CC</th>
              <th>TelÃ©fono</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let contact of service.contacts" class="data-row">
              <td class="cell-name">{{ contact.name || '-' }}</td>
              <td class="cell-email clickable"
                  (click)="copyToClipboard(contact.role === 'PARA' ? contact.email : '-')">
                {{ contact.role === 'PARA' ? (contact.email || '-') : '-' }}
              </td>
              <td class="cell-email clickable"
                  (click)="copyToClipboard(contact.role === 'CC' ? contact.email : '-')">
                {{ contact.role === 'CC' ? (contact.email || '-') : '-' }}
              </td>
              <td class="cell-phone highlight">{{ contact.phone || '-' }}</td>
            </tr>
            <tr *ngIf="!service.contacts || service.contacts.length === 0" class="no-data-row">
              <td colspan="4" class="text-center text-muted">Sin contactos configurados</td>
            </tr>
          </tbody>
        </table>
      </div>


      <!-- Sin servicios -->
      <div *ngIf="!selectedClientData.services || selectedClientData.services.length === 0" class="no-data-message">
        <mat-icon>info</mat-icon>
        <p>No hay servicios configurados para este cliente</p>
      </div>
    </div>

    <!-- Sin datos -->
    <div *ngIf="!loading && (!selectedClient || allClients.length === 0)" class="no-data-message">
      <mat-icon>warning</mat-icon>
      <p>No hay datos de escalamiento disponibles</p>
    </div>
  </mat-card>

  <!-- Contactos sin servicio asignado (global) -->
  <mat-card class="section-card" *ngIf="!loading && unassignedContacts.length > 0">
    <h2>ðŸ“‹ Contactos sin servicio asignado</h2>
    <p class="subtitle">Asigna estos contactos a un servicio desde el administrador.</p>
    <div class="service-section">
      <table class="excel-table">
        <thead>
          <tr>
            <th rowspan="2" class="header-service">Escalamiento</th>
            <th rowspan="2" class="header-service">Servicio</th>
            <th colspan="2" class="header-contacts">EnvÃ­os de correos</th>
            <th rowspan="2" class="header-phone">Correo</th>
            <th rowspan="2" class="header-phone">TelÃ©fono</th>
          </tr>
          <tr>
            <th class="subheader">PARA</th>
            <th class="subheader">CC</th>
          </tr>
        </thead>
        <tbody>
            <tr *ngFor="let contact of unassignedContacts; let i = index" class="data-row">
              <td class="cell-service" *ngIf="i === 0" [attr.rowspan]="unassignedContacts.length">
                <strong>Sin servicio</strong>
              </td>
              <td class="cell-service" *ngIf="i === 0" [attr.rowspan]="unassignedContacts.length">
                <strong>-</strong>
              </td>
            <td class="cell-contact">
              <span *ngIf="contact.role === 'PARA'">{{ contact.name }}</span>
              <span *ngIf="contact.role !== 'PARA'">-</span>
            </td>
            <td class="cell-contact">
              <span *ngIf="contact.role === 'CC'">{{ contact.name }}</span>
              <span *ngIf="contact.role !== 'CC'">-</span>
            </td>
            <td class="cell-email">{{ contact.email || '-' }}</td>
            <td class="cell-phone">{{ contact.phone || '-' }}</td>
          </tr>
        </tbody>
      </table>
    </div>
  </mat-card>
</div>
