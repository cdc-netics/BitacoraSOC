<!-- 
  Entity Autocomplete - Template HTML
  
  Estructura:
    - mat-form-field con mat-label
    - input con mat-autocomplete
    - Botón "X" para limpiar (matSuffix)
    - mat-spinner mientras carga
    - Panel con lista de resultados o mensaje "Sin resultados"
-->
<mat-form-field appearance="outline" class="entity-autocomplete-field">
  <mat-label>{{ label }}</mat-label>
  
  <input
    #inputField
    type="text"
    matInput
    [placeholder]="placeholder"
    [formControl]="searchControl"
    [matAutocomplete]="auto"
    [disabled]="disabled"
    autocomplete="off"
    matAutocompleteTrigger
  />

  <!-- Botón para limpiar selección -->
  <button
    *ngIf="selectedItem && !disabled"
    matSuffix
    mat-icon-button
    type="button"
    aria-label="Limpiar"
    (click)="clearSelection()"
  >
    <mat-icon>close</mat-icon>
  </button>

  <!-- Botón para desplegar lista -->
  <button
    *ngIf="!disabled"
    matSuffix
    mat-icon-button
    type="button"
    aria-label="Mostrar opciones"
    (click)="openPanel()"
  >
    <mat-icon>arrow_drop_down</mat-icon>
  </button>

  <!-- Spinner mientras busca -->
  <mat-spinner 
    *ngIf="isLoading" 
    matSuffix 
    diameter="20"
  ></mat-spinner>

  <!-- Hint opcional -->
  <mat-hint *ngIf="!selectedItem">
    Escribe al menos {{ minChars }} caracteres para buscar
  </mat-hint>
</mat-form-field>

<!-- Autocomplete panel -->
<mat-autocomplete
  #auto="matAutocomplete"
  [displayWith]="displayWith"
  (optionSelected)="onItemSelected($event)"
  class="entity-autocomplete-panel"
>
  <mat-option 
    *ngFor="let item of filteredItems$ | async; trackBy: trackByItemId" 
    [value]="item"
    class="entity-autocomplete-option"
  >
    <div class="option-content">
      <!-- Nombre principal -->
      <div class="option-name">
        {{ item.name }}
      </div>
      
      <!-- Parent (si existe) -->
      <div class="option-parent" *ngIf="item.parent">
        <mat-icon class="parent-icon">folder</mat-icon>
        {{ item.parent }}
      </div>
      
      <!-- Descripción truncada (si existe) -->
      <div class="option-description" *ngIf="item.description">
        {{ truncateText(item.description, 80) }}
      </div>
    </div>
  </mat-option>

  <!-- Mensaje "Sin resultados" -->
  <mat-option 
    *ngIf="(filteredItems$ | async)?.length === 0 && shouldShowNoResults"
    disabled
    class="no-results-option"
  >
    <mat-icon>search_off</mat-icon>
    <span>Sin resultados</span>
  </mat-option>
</mat-autocomplete>
